<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <!-- 引入图标样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/simple-line-icons@2.5.5/css/simple-line-icons.css" rel="stylesheet">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="{% static 'css/components.chunk.css' %}">
    <link rel="stylesheet" href="{% static 'css/umi.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'js/custom.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>

    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#343a40">

    <title>智慧医疗问答系统</title>
</head>

<body>
    <div id="root">
        <div id="page-container" class="null sidebar-o sidebar-dark page-header-dark side-scroll page-header-fixed main-content-boxed side-trans-enabled false">
            <div class="v2board-nav-mask" style="display: none;"></div>
            <nav id="sidebar">
                <div class="smini-hidden bg-header-dark">
                    <div class="content-header justify-content-lg-center bg-white-10"><a class="font-size-lg text-white" href="/medical/homepage/"><span class="text-white-75">智慧医疗问答系统</span></a>
                        <div class="d-lg-none"><a class="text-white ml-2" data-toggle="layout" data-action="sidebar_close" href="javascript:void(0);"><i class="fa fa-times-circle"></i></a></div>
                    </div>
                </div>
                <div class="content-side content-side-full">
                    <ul class="nav-main">
                        <li class="nav-main-heading">欢迎光临</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/homepage/"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">主页</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/instruction/"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">使用说明</span></a></li>
                        <li class="nav-main-heading">功能</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/guess/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">猜你所想</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/microscope/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">病痛显微镜</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/inquiry/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">龙灵问疾</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link active"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">龙灵问疾（Plus Beta）</span></a></li>
                        <li class="nav-main-heading">用户</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/user/"><i class="nav-main-link-icon si si-users"></i><span class="nav-main-link-name">用户中心</span></a></li>
                        <li class="nav-main-heading">关于</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/illustration/"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">说明</span></a></li>

                    </ul>
                </div>
                <div class="v2board-copyright">智慧医疗问答系统 v1.0.0</div>
            </nav>
            <header id="page-header">
                <div class="content-header">
                    <div class="sidebar-toggle" style="display: none;"><button type="button" class="btn btn-primary mr-1 d-lg-none"><i class="fa fa-fw fa-bars"></i></button></div>
                    <div class="v2board-container-title text-white">龙灵问疾</div>
                    <div>
                        <div class="dropdown d-inline-block">
                            <button type="button" class="btn btn-primary dropdown-button">
                                <i class="far fa fa-user-circle"></i>
                                <span class="d-none d-lg-inline ml-1">{{ user_info.username }}</span>
                                <i class="fa fa-fw fa-angle-down ml-1"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right p-0 false">
                                <div class="p-2">
                                    <a class="dropdown-item" href="/medical/user/">
                                        <i class="far fa-fw fa-user mr-1"></i> 用户中心
                                    </a>
                                    <a class="dropdown-item" href="/medical/login/">
                                        <i class="far fa-fw fa-arrow-alt-circle-left mr-1"></i> 登出
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main id="main-container">
                <div class="content content-full">
                    <div class="row mb-3 mb-md-0">
                        <div class="col-md-12">
                            <section class="msger">
                                <header class="msger-header">
                                    <div class="msger-header-title">
                                        <i class="fas fa-comment-alt"></i> 龙灵
                                    </div>
                                    <div class="msger-header-options">
                                        <span><i class="fas fa-cog"></i></span>
                                    </div>
                                </header>

                                <main class="msger-chat">
                                    <div class="msg left-msg">
                                        <div class="msg-img" style="background-image: url(https://chat.openai.com/favicon.ico)"></div>

                                        <div class="msg-bubble">
                                            <div class="msg-info">
                                                <div class="msg-info-name">龙灵</div>
                                                <div class="msg-info-time">
                                                    <a id="current-time"></a>
                                                </div>
                                            </div>

                                            <div class="msg-text">
                                                欢迎来到龙灵问疾（Plus Beta），在此输入你的症状描述文本，我会为您智能匹配到疾病。菜单项可以选择不同算法哦！😄
                                            </div>
                                        </div>
                                    </div>

                                    <div class="msg right-msg">
                                        <div class="msg-img" style="background-image: url(/static/image/user.jpg)"></div>

                                        <div class="msg-bubble">
                                            <div class="msg-info">
                                                <div class="msg-info-name">用户</div>
                                                <div class="msg-info-time">
                                                    <a id="current-time"></a>
                                                </div>
                                            </div>
                                            <div class="msg-text">
                                                龙灵小姐姐你好呀，我想问一些问题喔！
                                            </div>
                                        </div>
                                    </div>
                                </main>

                                <div class="msger-inputarea">
                                    <input type="text" id="user-input" class="msger-input" placeholder="在此处输入症状文本" onkeydown="handleEnter(event)">
                                    <select id="method">
                                        <option value="True">计数算法</option>
                                        <option value="False">向量算法</option>
                                    </select>
                                    <button type="submit" class="msger-send-btn" onclick="sendMessage()">发送</button>

                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        const msgerForm = get(".msger-inputarea");
        const msgerInput = get(".msger-input");
        const msgerChat = get(".msger-chat");
        const BOT_IMG = "https://chat.openai.com/favicon.ico";
        const PERSON_IMG = "/static/image/user.jpg";
        const BOT_NAME = "龙灵";
        const PERSON_NAME = "用户";

        function handleEnter(event) {
            if (event.keyCode === 13) {
                sendMessage();
            }
        }

        // 添加 sendMessage 函数
        function sendMessage() {
            event.preventDefault();
            const userInput = document.getElementById('user-input');
            const msgText = userInput.value.trim()
                // 使用 fetch 方法发送 POST 请求
            if (msgText == '') {
                alert('输入框空白，请输入');
                return;
            }
            // 获取下拉菜单的选项值
            const method = document.getElementById('method').value;
            appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
            fetch('/medical/inquiryplus/', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'X-CSRFToken': getCookie('csrftoken'), // 获取并设置CSRF令牌
                    },
                    body: JSON.stringify({
                        message: msgText,
                        method: method,
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 在收到响应后处理后端的回复
                    const botResponse = data.message;
                    if (botResponse.length !== 0) {
                        const linkList = botResponse.map(item => `<a href="http://127.0.0.1:8000/medical/microscope/${encodeURIComponent(item)}">${item}</a>`).join('<br>');
                        const messageText = `这是灵灵找到的相关疾病，如果对您有帮助灵灵就会十分开心呀：<br>${linkList}<br>点击链接既可以查看到疾病的详细信息，感谢使用哦！`;
                        appendMessage(BOT_NAME, BOT_IMG, "left", messageText);
                    } else {
                        appendMessage(BOT_NAME, BOT_IMG, "left", "未在数据库中检测到相关信息，请重试");
                    }
                })

            .catch(error => {
                console.error("发送请求时出现错误:", error);
            });
            msgerInput.value = "";
        }


        function appendMessage(name, img, side, text) {
            const msgHTML = `
            <div class="msg ${side}-msg">
            <div class="msg-img" style="background-image: url(${img})"></div>

            <div class="msg-bubble">
                <div class="msg-info">
                <div class="msg-info-name">${name}</div>
                <div class="msg-info-time">${formatDate(new Date())}</div>
                </div>

                <div class="msg-text">${text}</div> 
                </div> 
                </div>
            `;
            msgerChat.insertAdjacentHTML("beforeend", msgHTML);
            msgerChat.scrollTop += 500;
        }

        // Utils
        // 获取并设置CSRF令牌
        function getCookie(name) {
            const value = `;
            $ {
                document.cookie
            }
            `;
            const parts = value.split(`;
            $ {
                name
            } = `);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function get(selector, root = document) {
            return root.querySelector(selector);
        }

        function formatDate(date) {
            const h = "0" + date.getHours();
            const m = "0" + date.getMinutes();
            return `${h.slice(-2)}:${m.slice(-2)}`;
        }
    </script>
</body>

</html>